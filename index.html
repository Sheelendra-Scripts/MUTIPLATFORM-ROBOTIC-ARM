<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Robotic Arm Controller</title>
    <style>
        /* --- Basic reset and layout --- */
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh;padding:18px;color:#333;
        }
        .container{
            max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.96);
            border-radius:18px;padding:26px;box-shadow:0 20px 40px rgba(0,0,0,0.12);
            backdrop-filter: blur(6px);
        }
        .header{text-align:center;margin-bottom:18px}
        .header h1{color:#2c3e50;font-size:2rem;margin-bottom:8px}
        .header p{color:#586573;font-size:0.95rem}

        /* --- Connection panel --- */
        .connection-panel{
            background:#34495e;color:white;padding:16px;border-radius:12px;margin-bottom:18px;
            display:flex;flex-wrap:wrap;align-items:center;gap:10px;justify-content:space-between;
        }
        .left, .right { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .btn{
            background:linear-gradient(45deg,#3498db,#2980b9);color:white;border:none;padding:10px 16px;border-radius:20px;
            cursor:pointer;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.12);
        }
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        .btn-success{background:linear-gradient(45deg,#27ae60,#219a52)}
        .btn-danger{background:linear-gradient(45deg,#e74c3c,#c0392b)}
        .btn-warning{background:linear-gradient(45deg,#f39c12,#e67e22)}
        .status{display:inline-block;padding:8px 14px;border-radius:20px;font-weight:700}
        .status.disconnected{background:#e74c3c;color:white}
        .status.connected{background:#27ae60;color:white}

        /* --- Controls grid --- */
        .controls-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px;margin:18px 0}
        .servo-control{background:white;border-radius:12px;padding:18px;border:2px solid #ecf0f1;box-shadow:0 8px 20px rgba(0,0,0,0.06)}
        .servo-label{font-weight:700;color:#2c3e50;margin-bottom:10px;text-align:center}
        .slider{width:100%;height:8px;border-radius:6px;background:#ecf0f1;appearance:none;outline:none}
        .slider::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:linear-gradient(45deg,#3498db,#2980b9);cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.18)}
        .value-display{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
        .current-value{background:#3498db;color:white;padding:6px 12px;border-radius:14px;font-weight:700;min-width:54px;text-align:center}
        .preset-buttons{display:flex;gap:8px;flex-wrap:wrap}
        .preset-btn{background:#95a5a6;color:white;border:none;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:13px}
        .preset-btn:disabled{opacity:0.5;cursor:not-allowed}

        /* --- Speed & system controls --- */
        .speed-control{background:white;border-radius:12px;padding:14px;border:2px solid #ecf0f1;text-align:center;margin-bottom:12px}
        .speed-slider{width:200px;height:8px}
        .system-controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}

        /* --- Logs --- */
        .log-panel{background:#2c3e50;color:#ecf0f1;border-radius:10px;padding:12px;height:160px;overflow-y:auto;font-family:monospace;font-size:13px}
        .log-entry{margin-bottom:6px}
        .log-sent{color:#82c0ff}
        .log-received{color:#9be6a7}
        .log-error{color:#ffb3b3}
        .note{font-size:12px;color:#7f8c8d;margin-top:8px;text-align:center}

        @media (max-width:700px){
            .connection-panel{flex-direction:column;align-items:stretch;gap:8px}
            .left,.right{justify-content:center}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Robotic Arm Controller</h1>
            <p>Combined Bluetooth (BLE) + USB Serial interface — HC-05 compatible</p>
        </div>

        <div class="connection-panel" role="region" aria-label="connection panel">
            <div class="left">
                <button class="btn" id="btnConnectBT">📱 Connect Bluetooth</button>
                <button class="btn" id="btnConnectSerial">🔌 Connect USB Serial</button>
                <button class="btn btn-success" id="btnArmConnect">✅ Connect Arm</button>
                <button class="btn btn-danger" id="btnArmDisconnect">❌ Disconnect Arm</button>
            </div>

            <div class="right">
                <span id="status" class="status disconnected">Disconnected</span>
                <div class="note">💡 HC-05 BLE support varies. If BLE fails, try USB Serial or mobile Bluetooth terminal app.</div>
            </div>
        </div>

        <div class="controls-grid" id="controlsGrid">
            <!-- Joint 1 -->
            <div class="servo-control">
                <div class="servo-label">Joint 1 - Base Rotation</div>
                <input type="range" min="0" max="180" value="0" class="slider" id="servo0" data-index="1">
                <div class="value-display">
                    <span id="value0" class="current-value">0°</span>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-servo="0" data-val="0">0°</button>
                        <button class="preset-btn" data-servo="0" data-val="45">45°</button>
                        <button class="preset-btn" data-servo="0" data-val="90">90°</button>
                        <button class="preset-btn" data-servo="0" data-val="135">135°</button>
                        <button class="preset-btn" data-servo="0" data-val="180">180°</button>
                    </div>
                </div>
            </div>

            <!-- Joint 2 -->
            <div class="servo-control">
                <div class="servo-label">Joint 2 - Shoulder</div>
                <input type="range" min="0" max="180" value="90" class="slider" id="servo1" data-index="2">
                <div class="value-display">
                    <span id="value1" class="current-value">90°</span>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-servo="1" data-val="0">0°</button>
                        <button class="preset-btn" data-servo="1" data-val="45">45°</button>
                        <button class="preset-btn" data-servo="1" data-val="90">90°</button>
                        <button class="preset-btn" data-servo="1" data-val="135">135°</button>
                        <button class="preset-btn" data-servo="1" data-val="180">180°</button>
                    </div>
                </div>
            </div>

            <!-- Joint 3 -->
            <div class="servo-control">
                <div class="servo-label">Joint 3 - Elbow</div>
                <input type="range" min="0" max="180" value="90" class="slider" id="servo2" data-index="3">
                <div class="value-display">
                    <span id="value2" class="current-value">90°</span>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-servo="2" data-val="0">0°</button>
                        <button class="preset-btn" data-servo="2" data-val="45">45°</button>
                        <button class="preset-btn" data-servo="2" data-val="90">90°</button>
                        <button class="preset-btn" data-servo="2" data-val="135">135°</button>
                        <button class="preset-btn" data-servo="2" data-val="180">180°</button>
                    </div>
                </div>
            </div>

            <!-- Joint 4 -->
            <div class="servo-control">
                <div class="servo-label">Joint 4 - Wrist Pitch</div>
                <input type="range" min="0" max="180" value="90" class="slider" id="servo3" data-index="4">
                <div class="value-display">
                    <span id="value3" class="current-value">90°</span>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-servo="3" data-val="0">0°</button>
                        <button class="preset-btn" data-servo="3" data-val="45">45°</button>
                        <button class="preset-btn" data-servo="3" data-val="90">90°</button>
                        <button class="preset-btn" data-servo="3" data-val="135">135°</button>
                        <button class="preset-btn" data-servo="3" data-val="180">180°</button>
                    </div>
                </div>
            </div>

            <!-- Joint 5 -->
            <div class="servo-control">
                <div class="servo-label">Joint 5 - Wrist Roll</div>
                <input type="range" min="0" max="180" value="90" class="slider" id="servo4" data-index="5">
                <div class="value-display">
                    <span id="value4" class="current-value">90°</span>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-servo="4" data-val="0">0°</button>
                        <button class="preset-btn" data-servo="4" data-val="45">45°</button>
                        <button class="preset-btn" data-servo="4" data-val="90">90°</button>
                        <button class="preset-btn" data-servo="4" data-val="135">135°</button>
                        <button class="preset-btn" data-servo="4" data-val="180">180°</button>
                    </div>
                </div>
            </div>

            <!-- Joint 6 - Gripper: restricted to 90..180 -->
            <div class="servo-control">
                <div class="servo-label">Joint 6 - Gripper (range: 90° — 180°)</div>
                <input type="range" min="90" max="180" value="90" class="slider" id="servo5" data-index="6">
                <div class="value-display">
                    <span id="value5" class="current-value">90°</span>
                    <div class="preset-buttons">
                        <button class="preset-btn" data-servo="5" data-val="90">Close (90°)</button>
                        <button class="preset-btn" data-servo="5" data-val="135">Half (135°)</button>
                        <button class="preset-btn" data-servo="5" data-val="180">Open (180°)</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="speed-control">
            <h3 style="margin-bottom:8px">Movement Speed</h3>
            <input type="range" min="1" max="100" value="50" class="slider speed-slider" id="speedSlider">
            <div style="margin-top:10px">
                <span id="speedValue" class="current-value">50</span>
            </div>
        </div>

        <div class="system-controls">
            <button class="btn btn-warning" id="btnSave">💾 Save Position</button>
            <button class="btn btn-success" id="btnRun">▶️ Run Saved</button>
            <button class="btn" id="btnReset">🔄 Reset to Home</button>
            <button class="btn btn-warning" id="btnPause">⏸️ Pause</button>
            <button class="btn btn-success" id="btnResume">⏯️ Resume</button>
        </div>

        <div class="log-panel" id="logPanel" aria-live="polite">
            <div class="log-entry">🤖 Robotic Arm Controller Ready</div>
            <div class="log-entry">📱 HC-05 BLE compatibility varies by firmware version</div>
            <div class="log-entry">🔌 For reliable connection, use USB serial or mobile Bluetooth app</div>
        </div>
    </div>

    <script>
        /******************************************************************
         * HC-05 Compatible BLE + Web Serial controller
         * - Enhanced service discovery for HC-05 modules
         * - Fallback mechanisms for different BLE implementations
         ******************************************************************/

        // ===== Global state =====
        let bluetoothDevice = null;
        let bluetoothCharacteristic = null;
        let serialPort = null;
        let serialReader = null;
        let connectedVia = null; // "ble" | "serial" | null
        let isArmConnected = false;

        // DOM
        const logPanel = document.getElementById('logPanel');
        const statusEl = document.getElementById('status');
        const btnConnectBT = document.getElementById('btnConnectBT');
        const btnConnectSerial = document.getElementById('btnConnectSerial');
        const btnArmConnect = document.getElementById('btnArmConnect');
        const btnArmDisconnect = document.getElementById('btnArmDisconnect');
        const controlsGrid = document.getElementById('controlsGrid');

        // Utility: add log
        function addLog(message, type='info') {
            const e = document.createElement('div');
            e.className = 'log-entry';
            if (type === 'sent') e.classList.add('log-sent');
            if (type === 'received') e.classList.add('log-received');
            if (type === 'error') e.classList.add('log-error');

            const timestamp = new Date().toLocaleTimeString();
            e.textContent = `${timestamp} — ${message}`;
            logPanel.appendChild(e);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // ===== Connection status UI =====
        function updateConnectionStatus() {
            if (connectedVia && isArmConnected) {
                statusEl.textContent = `Connected (${connectedVia.toUpperCase()})`;
                statusEl.className = 'status connected';
                setControlsEnabled(true);
            } else if (connectedVia) {
                statusEl.textContent = `Link Ready (${connectedVia.toUpperCase()})`;
                statusEl.className = 'status connected';
                setControlsEnabled(false);
            } else {
                statusEl.textContent = 'Disconnected';
                statusEl.className = 'status disconnected';
                setControlsEnabled(false);
            }
        }

        // Enable/disable all interactive controls
        function setControlsEnabled(enabled) {
            const sl = document.querySelectorAll('.slider');
            sl.forEach(s => s.disabled = !enabled);

            const pbs = document.querySelectorAll('.preset-btn');
            pbs.forEach(b => b.disabled = !enabled);

            document.getElementById('btnSave').disabled = !enabled;
            document.getElementById('btnRun').disabled = !enabled;
            document.getElementById('btnReset').disabled = !enabled;
            document.getElementById('btnPause').disabled = !enabled;
            document.getElementById('btnResume').disabled = !enabled;

            btnConnectBT.disabled = false;
            btnConnectSerial.disabled = false;
            btnArmConnect.disabled = !connectedVia;
            btnArmDisconnect.disabled = !isArmConnected;
        }

        function onBleDisconnected(event) {
            addLog(`Bluetooth device disconnected: ${event.target.name || 'Unknown device'}`, 'error');
            bluetoothDevice = null;
            bluetoothCharacteristic = null;
            connectedVia = null;
            isArmConnected = false;
            updateConnectionStatus();
        }

        // ===== Enhanced BLE Connection for HC-05 =====
        async function connectBluetooth() {
            if (!('bluetooth' in navigator)) {
                addLog('Web Bluetooth API not supported in this browser.', 'error');
                return;
            }

            try {
                addLog('Requesting Bluetooth device...');

                // Enhanced service list for HC-05 and other BLE modules
                const serviceUUIDs = [
                    '6e400001-b5a3-f393-e0a9-e50e24dcca9e', // Nordic UART Service
                    '0000ffe0-0000-1000-8000-00805f9b34fb', // Common HC-05/HC-06 service
                    '49535343-fe7d-4ae5-8fa9-9fafd205e455', // Microchip transparent UART
                    '6e400001-b5a3-f393-e0a9-e50e24dcca9e', // Another Nordic UART variant
                    '0000180f-0000-1000-8000-00805f9b34fb', // Battery service (sometimes present)
                    'generic_access',
                    'generic_attribute'
                ];

                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: serviceUUIDs
                });

                bluetoothDevice.addEventListener('gattserverdisconnected', onBleDisconnected);

                addLog(`Connecting to GATT server (${bluetoothDevice.name || 'Unknown'})...`);
                const server = await bluetoothDevice.gatt.connect();

                addLog('Discovering services...');
                let services;
                try {
                    services = await server.getPrimaryServices();
                } catch (err) {
                    addLog('Failed to get primary services, trying individual service discovery...', 'error');
                    // Try to connect to known services individually
                    services = await tryIndividualServices(server, serviceUUIDs);
                }

                if (!services || services.length === 0) {
                    throw new Error('No services found. HC-05 may not support BLE properly.');
                }

                addLog(`Found ${services.length} service(s), searching for writable characteristic...`);

                // Try to find writable characteristics with multiple approaches
                const characteristic = await findWritableCharacteristic(services);
                
                if (characteristic) {
                    bluetoothCharacteristic = characteristic;
                    addLog('✅ Writable characteristic found! BLE link ready.', 'received');
                    connectedVia = 'ble';
                    updateConnectionStatus();
                    return;
                }

                throw new Error('No writable characteristic found. This HC-05 may not support BLE data transfer.');

            } catch (err) {
                addLog(`Bluetooth connect failed: ${err.message}`, 'error');
                if (err.message.includes('No Services found')) {
                    addLog('💡 This HC-05 appears to be classic Bluetooth only. Try USB Serial or mobile app.', 'error');
                }
                bluetoothDevice = null;
                bluetoothCharacteristic = null;
                connectedVia = null;
                updateConnectionStatus();
            }
        }

        // Try to discover services individually (fallback method)
        async function tryIndividualServices(server, serviceUUIDs) {
            const foundServices = [];
            
            for (const uuid of serviceUUIDs) {
                try {
                    const service = await server.getPrimaryService(uuid);
                    foundServices.push(service);
                    addLog(`Found service: ${uuid}`);
                } catch (e) {
                    // Service not found, continue
                }
            }
            
            return foundServices;
        }

        // Enhanced characteristic discovery
        async function findWritableCharacteristic(services) {
            // Known characteristic UUIDs for UART services
            const knownUUIDs = [
                '6e400002-b5a3-f393-e0a9-e50e24dcca9e', // Nordic UART TX
                '0000ffe1-0000-1000-8000-00805f9b34fb', // Common HC-05 characteristic
                '49535343-1e4d-4bd9-ba61-23c647249616', // Microchip data
                '6e400003-b5a3-f393-e0a9-e50e24dcca9e'  // Nordic UART RX (sometimes writable)
            ];

            // First, try known UUIDs
            for (const service of services) {
                for (const uuid of knownUUIDs) {
                    try {
                        const char = await service.getCharacteristic(uuid);
                        if (char.properties.write || char.properties.writeWithoutResponse) {
                            addLog(`Found known writable characteristic: ${uuid}`);
                            return char;
                        }
                    } catch (e) {
                        // Characteristic not found, continue
                    }
                }
            }

            // Fallback: scan all characteristics
            for (const service of services) {
                try {
                    const characteristics = await service.getCharacteristics();
                    for (const char of characteristics) {
                        if (char.properties.write || char.properties.writeWithoutResponse) {
                            addLog(`Found writable characteristic: ${char.uuid}`);
                            return char;
                        }
                    }
                } catch (e) {
                    addLog(`Error scanning service ${service.uuid}: ${e.message}`);
                }
            }

            return null;
        }

        // ===== Web Serial (USB) =====
        async function connectSerial() {
            if (!('serial' in navigator)) {
                addLog('Web Serial API not supported in this browser. Use Chrome/Edge.', 'error');
                return;
            }

            try {
                addLog('Requesting serial port...');
                serialPort = await navigator.serial.requestPort();
                await serialPort.open({ baudRate: 9600, dataBits: 8, stopBits: 1, parity: 'none' });
                addLog('Serial port opened.', 'received');
                connectedVia = 'serial';
                startSerialReader();
                updateConnectionStatus();
            } catch (err) {
                addLog(`Serial connection failed: ${err.message}`, 'error');
                serialPort = null;
                connectedVia = null;
                updateConnectionStatus();
            }
        }

        async function startSerialReader() {
            if (!serialPort || !serialPort.readable) return;
            try {
                serialReader = serialPort.readable.getReader();
                let buffer = '';
                const decoder = new TextDecoder();
                while (true) {
                    const { value, done } = await serialReader.read();
                    if (done) break;
                    if (value) {
                        const chunk = decoder.decode(value);
                        buffer += chunk;
                        let idx;
                        while ((idx = buffer.indexOf('\n')) !== -1) {
                            const line = buffer.slice(0, idx).trim();
                            buffer = buffer.slice(idx + 1);
                            if (line) {
                                addLog(`Received: ${line}`, 'received');
                                if (line.includes('Connected')) {
                                    isArmConnected = true;
                                } else if (line.includes('Disconnected')) {
                                    isArmConnected = false;
                                }
                                updateConnectionStatus();
                            }
                        }
                    }
                }
            } catch (err) {
                if (err.name !== 'AbortError') addLog(`Serial read error: ${err.message}`, 'error');
            } finally {
                try { serialReader.releaseLock(); } catch (e){}
            }
        }

        async function disconnectSerial() {
            try {
                if (serialReader) {
                    await serialReader.cancel();
                    serialReader = null;
                }
                if (serialPort) {
                    await serialPort.close();
                    serialPort = null;
                }
                addLog('Serial port closed.', 'info');
            } catch (err) {
                addLog(`Error closing serial: ${err.message}`, 'error');
            } finally {
                if (connectedVia === 'serial') connectedVia = null;
                isArmConnected = false;
                updateConnectionStatus();
            }
        }

        // ===== Send command logic =====
        async function sendCommand(command) {
            const payload = command + '\n';
            const encoder = new TextEncoder();

            if (!connectedVia) {
                addLog('No transport available. Connect Bluetooth or USB Serial first.', 'error');
                return;
            }

            try {
                if (connectedVia === 'ble' && bluetoothCharacteristic) {
                    // Try different write methods for HC-05 compatibility
                    try {
                        await bluetoothCharacteristic.writeValue(encoder.encode(payload));
                    } catch (writeError) {
                        // Try writeValueWithoutResponse if regular write fails
                        if (bluetoothCharacteristic.properties.writeWithoutResponse) {
                            await bluetoothCharacteristic.writeValueWithoutResponse(encoder.encode(payload));
                        } else {
                            throw writeError;
                        }
                    }
                    addLog(`Sent via BLE: ${command}`, 'sent');
                } else if (connectedVia === 'serial' && serialPort && serialPort.writable) {
                    const writer = serialPort.writable.getWriter();
                    await writer.write(encoder.encode(payload));
                    writer.releaseLock();
                    addLog(`Sent via Serial: ${command}`, 'sent');
                } else {
                    throw new Error('No active writable transport');
                }
            } catch (err) {
                addLog(`Failed to send "${command}": ${err.message}`, 'error');
                // If BLE write fails, suggest alternatives
                if (connectedVia === 'ble') {
                    addLog('💡 BLE write failed. HC-05 may have limited BLE support. Try USB Serial.', 'error');
                }
            }
        }

        // ===== Arm connect / disconnect =====
        async function armConnect() {
            if (!connectedVia) {
                addLog('No link to arm. Connect Bluetooth or Serial first.', 'error');
                return;
            }
            addLog('Attempting to connect to arm (sending CONNECT)...', 'info');
            await sendCommand('CONNECT');
            isArmConnected = true;
            updateConnectionStatus();
        }

        async function armDisconnect() {
            if (!connectedVia) {
                addLog('No link to arm.', 'error');
                return;
            }
            addLog('Sending DISCONNECT to arm...', 'info');
            await sendCommand('DISCONNECT');
            isArmConnected = false;
            updateConnectionStatus();
        }

        // ===== UI interactions =====
        function makeServoCommand(servoIndex, position) {
            const pos = Math.max(0, Math.min(180, Math.round(Number(position))));
            return `s${servoIndex}${pos}`;
        }

        // Hook sliders
        document.querySelectorAll('.slider').forEach(slider => {
            slider.addEventListener('input', (e) => {
                const idx = Number(slider.dataset.index);
                const pos = slider.value;
                const display = document.getElementById(`value${idx-1}`);
                if (display) display.textContent = `${pos}°`;
                if (isArmConnected) {
                    const cmd = makeServoCommand(idx, pos);
                    sendCommand(cmd);
                }
            });
        });

        // Hook preset buttons
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const servoIdxZero = Number(btn.dataset.servo);
                const val = Number(btn.dataset.val);
                const slider = document.getElementById(`servo${servoIdxZero}`);
                if (slider) {
                    slider.value = val;
                    const idx = Number(slider.dataset.index);
                    const display = document.getElementById(`value${idx-1}`);
                    if (display) display.textContent = `${val}°`;
                }
                if (isArmConnected) {
                    const idx = servoIdxZero + 1;
                    sendCommand(makeServoCommand(idx, val));
                }
            });
        });

        // Speed control
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        speedSlider.addEventListener('input', () => {
            const v = speedSlider.value;
            speedValue.textContent = v;
            if (isArmConnected) sendCommand(`ss${v}`);
        });

        // System control buttons
        document.getElementById('btnSave').addEventListener('click', () => { if (isArmConnected) sendCommand('SAVE'); });
        document.getElementById('btnRun').addEventListener('click', () => { if (isArmConnected) sendCommand('RUN'); });
